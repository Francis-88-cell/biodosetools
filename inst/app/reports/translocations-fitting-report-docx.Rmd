---
title: "Curve fitting report"
author: "`r paste('Biodose Tools', '-', app_version)`"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
output: word_document
params:
  fit_results_list: NA
---

```{r include=FALSE} 
pander::panderOptions("table.style", "grid")
```

```{r load-data, echo=FALSE}
count_data <- params$fit_results_list[["fit_raw_data"]]
fit_model_statistics <- params$fit_results_list[["fit_model_statistics"]]
fit_model_summary <- params$fit_results_list[["fit_model_summary"]]
fit_coeffs <- params$fit_results_list[["fit_coeffs"]]
fit_var_cov_mat <- params$fit_results_list[["fit_var_cov_mat"]]
fit_cor_mat <- params$fit_results_list[["fit_cor_mat"]]
fit_formula_tex <- params$fit_results_list[["fit_formula_tex"]]
gg_curve <- params$fit_results_list[["gg_curve"]]
# detection_lims <- params$fit_results_list[["detection_lims"]]

genome_fraction <- params$fit_results_list[["genome_fraction"]]
chromosome_table <- params$fit_results_list[["chromosome_table"]]
trans_sex <- params$fit_results_list[["trans_sex"]]
frequency_select <- params$fit_results_list[["frequency_select"]]
```

## Chromosome data

The analyzed blood sample comes from a `r trans_sex` individual.

```{r echo=FALSE}
num_cols <- ncol(chromosome_table)

chromosome_table <- chromosome_table %>% 
  as.data.frame() 

if (num_cols > 1) {
  chromosome_table <- chromosome_table %>% 
    mutate_at(seq(2, num_cols , 1), function(x) {
      case_when(
        is.na(x) ~ "",
        (x == "FALSE") ~ "",
        (x == "TRUE") ~ "x",
      )
    })
}

chromosome_table%>% 
  pander::pander()
```

## Count data used
```{r echo=FALSE}
count_data %>% 
  dplyr::rename(`D (Gy)` = D) %>% 
  pander::pander()
  # TODO:  hot_col(c(1), format = "0.000", colWidths = 60)
  # TODO: Add u-value highlighting
```

## Results

### Fit formula
```{r echo=FALSE}
withMathJax(paste0("$$", fit_formula_tex, "$$"))
```

### Model
`r fit_model_summary`

### Translocation frequency
`r paste("The fitting was performed using the ")`
`r if (frequency_select == "full_gen_freq") paste("full genome translocation frequency.") else if (frequency_select == "measured_freq") paste("translocation frequency measured by FISH.")`

### Genomic conversion factor
`r paste0("The genomic conversion factor to full genome is ", genome_fraction %>% round(3) %>%  as.character(), ".")`

### Coefficients
```{r echo=FALSE}
fit_coeffs %>%
  formatC(format = "e", digits = 3) %>%
  # as.data.frame() %>%
  # dplyr::select(-statistic) %>%
  # as.matrix() %>%
  pander::pander()
```

### Model-level statistics
```{r echo=FALSE}
fit_model_statistics %>%
  pander::pander()
```

### Correlation matrix
```{r echo=FALSE}
fit_cor_mat %>%
  formatC(format = "f", digits = 3) %>%
  pander::pander()
```

### Variance-covariance matrix
```{r echo=FALSE}
fit_var_cov_mat %>%
  formatC(format = "e", digits = 3) %>%
  pander::pander()
```

<!-- ### Detection limits -->
<!-- ```{r echo=FALSE} -->
<!-- detection_lims %>% -->
<!--   `colnames<-`(c("N", "X95", "D (mGy)", "X83", "D (mGy)")) %>%  -->
<!--   pander::pander() -->
<!--   # TODO: hot_col(c(3, 5), format = "0.00", colWidths = 75)  -->
<!-- ``` -->

### Curve plot
```{r echo=FALSE}
gg_curve
```

### Download fit results
The DOCX format does not support embedded files. You can only save the results in RDS format from Biodose Tools or from the HTML report.
